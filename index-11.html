<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toadz Arena | Play to Earn</title>
    <link rel="stylesheet" href="arena.css">
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-container">
        <div class="bg-gradient"></div>
        <div class="grid-overlay"></div>
        <div class="scanlines"></div>
        <div class="particles" id="particles"></div>
    </div>

    <div class="app-wrapper">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>üéÆ TOADZ ARENA</h1>
                <div class="tagline">üí∞ Play ‚Ä¢ Earn ‚Ä¢ Dominate</div>
            </div>

            <!-- Wallet Stats Banner (hidden until connected) -->
            <div id="walletBanner" class="fomo-banner" style="display: none;">
                <div class="fomo-content">
                    <div class="fomo-stat">
                        <div class="fomo-value blue"><span id="walletAddrBanner"></span></div>
                        <div class="fomo-label">Wallet</div>
                    </div>
                    <div class="fomo-stat">
                        <div class="fomo-value gold"><span id="walletBalBanner">0</span></div>
                        <div class="fomo-label">Your POND</div>
                    </div>
                    <div class="fomo-stat">
                        <div class="fomo-value green"><span id="walletSGBBanner">0</span></div>
                        <div class="fomo-label">Your SGB</div>
                    </div>
                    <div class="fomo-stat">
                        <div class="fomo-value purple"><span id="marketcapBanner">$0</span></div>
                        <div class="fomo-label">POND MCAP</div>
                    </div>
                    <div class="fomo-stat">
                        <div class="fomo-value"><span id="gameCredits">0</span></div>
                        <div class="fomo-label">Game Credits</div>
                    </div>
                </div>
            </div>

            <!-- LP Stats Banner -->
            <div id="lpBanner" class="fomo-banner">
                <div class="fomo-content">
                    <div class="banner-title">POND LP STATS</div>
                    <div class="fomo-stat">
                        <div class="price-ticker">$<span id="pondPriceUSD">0.000084</span></div>
                        <div class="fomo-label">POND Price</div>
                    </div>
                    <div class="fomo-stat">
                        <div class="fomo-value purple">$<span id="marketcapLP">0</span></div>
                        <div class="fomo-label">Market Cap</div>
                    </div>
                    <div class="fomo-stat">
                        <div class="fomo-value green"><span id="priceChangePercent">+0.00</span>%</div>
                        <div class="fomo-label">24h Change</div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('play')">üéÆ PLAY</button>
                <button class="tab" onclick="switchTab('buy')">üí∞ BUY POND</button>
                <button class="tab" onclick="switchTab('pool')">üíß POOL</button>
                <button class="tab" onclick="switchTab('leaderboard')">üèÜ LEADERBOARD</button>
                <button class="tab marketplace-tab" onclick="switchTab('marketplace')">‚ú® MARKETPLACE</button>
            </div>

            <!-- ==================== PLAY TAB ==================== -->
            <div id="playTab" class="tab-content active">
                <!-- Wallet Connect Buttons -->
                <div class="flex flex-center flex-wrap gap-2 mb-3">
                    <button id="walletBtn" class="btn btn-primary" onclick="connectWallet()">üîó Connect Wallet</button>
                    <button id="networkBtn" class="btn btn-orange" onclick="addSongbirdNetwork()" style="display: none;">üåê Add Songbird</button>
                    <button id="importTokenBtn" class="btn btn-green" onclick="importBAKEToken()" style="display: none;">‚ûï Add $POND</button>
                </div>

                <!-- Game Setup Section -->
                <div id="gameSetup" style="display: none;">
                    <div class="cyber-card green glow">
                        <div class="corner tl"></div>
                        <div class="corner tr"></div>
                        <div class="corner bl"></div>
                        <div class="corner br"></div>
                        
                        <h3 class="section-title">üéüÔ∏è GAME CREDITS: <span id="creditsDisplay">0</span></h3>
                        
                        <div class="text-center mb-3">
                            <input type="text" id="username" class="cyber-input centered uppercase" placeholder="ENTER USERNAME" maxlength="8" style="max-width: 320px;">
                        </div>
                        
                        <div class="form-group text-center">
                            <div class="form-label">Buy Credits (1 SGB each)</div>
                            <div class="flex flex-center flex-wrap gap-2 mt-2" id="creditsGrid">
                                <button class="btn btn-green btn-sm" onclick="buyCredits(1)">Buy 1</button>
                                <button class="btn btn-green btn-sm" onclick="buyCredits(5)">Buy 5</button>
                                <button class="btn btn-green btn-sm" onclick="buyCredits(10)">Buy 10</button>
                                <button class="btn btn-purple btn-sm" onclick="buyCredits(25)">Buy 25</button>
                                <button class="btn btn-gold btn-sm" onclick="buyCredits(100)">Buy 100</button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <button id="payEntryBtn" class="btn btn-primary btn-lg" onclick="selectVehicle()">üéÆ USE CREDIT & CHOOSE VEHICLE</button>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Selection -->
                <div id="vehicleSelect" style="display: none;">
                    <h3 class="section-title blue">CHOOSE YOUR VEHICLE</h3>
                    <div class="grid-3 grid-auto-sm mb-3">
                        <div class="vehicle-card" onclick="selectVehicleType('üöú', 230, 40)">
                            <span class="vehicle-icon">üöú</span>
                            <div class="vehicle-name">Tank</div>
                            <div class="vehicle-stats">HP: 230 ‚Ä¢ DMG: 40</div>
                        </div>
                        <div class="vehicle-card" onclick="selectVehicleType('üèéÔ∏è', 92, 20)">
                            <span class="vehicle-icon">üèéÔ∏è</span>
                            <div class="vehicle-name">Sports Car</div>
                            <div class="vehicle-stats">HP: 92 ‚Ä¢ DMG: 20</div>
                        </div>
                        <div class="vehicle-card" onclick="selectVehicleType('üöö', 161, 30)">
                            <span class="vehicle-icon">üöö</span>
                            <div class="vehicle-name">Truck</div>
                            <div class="vehicle-stats">HP: 161 ‚Ä¢ DMG: 30</div>
                        </div>
                    </div>
                </div>

                <!-- Marketplace Upsell -->
                <div id="marketplaceUpsell" style="display: none;">
                    <h3 class="section-title pink">‚ö° NEED ANYTHING FROM THE MARKETPLACE?</h3>
                    <div id="upsellItems" class="grid-auto mb-3"></div>
                    <div class="flex flex-center gap-2">
                        <button class="btn btn-pink" onclick="switchTab('marketplace')">üõí Browse Marketplace</button>
                        <button class="btn btn-primary btn-lg" onclick="proceedToGame()">‚ñ∂Ô∏è START GAME</button>
                    </div>
                </div>

                <!-- Game Area -->
                <div id="gameArea" style="display: none;">
                    <div id="gameContainer">
                        <canvas id="gameCanvas"></canvas>
                        <div id="explosionOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0; background: radial-gradient(circle, rgba(255,100,0,0.6) 0%, rgba(255,0,0,0.3) 50%, transparent 100%);"></div>
                        
                        <!-- Prize Pot -->
                        <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%);">
                            <div class="prize-pot">
                                <div class="prize-pot-label">üí∞ PRIZE POT</div>
                                <div class="prize-pot-value"><span id="currentPot">10000</span> POND</div>
                            </div>
                        </div>
                        
                        <!-- Kill Notification -->
                        <div id="killNotif" class="kill-notif" style="position: absolute; top: 120px; left: 50%; transform: translateX(-50%); display: none;"></div>
                        
                        <!-- Left HUD -->
                        <div style="position: absolute; top: 20px; left: 20px;">
                            <div class="hud-panel">
                                <div class="hud-stat red">‚ù§Ô∏è <span id="playerHP">100</span>/<span id="playerMaxHP">100</span></div>
                                <div class="hud-stat green">üíö Lives: <span id="livesCount">5</span>/5</div>
                                <div class="hud-stat gold">üç∞ <span id="playerBAKE">0</span> POND</div>
                                <div class="hud-stat green">üèÜ <span id="killCount">0</span> kills</div>
                                <div class="hud-stat pink">üî• <span id="streakCount">0</span>x streak</div>
                                <div id="tacticalsDisplay" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-dim);"></div>
                            </div>
                        </div>
                        
                        <!-- Right HUD -->
                        <div style="position: absolute; top: 20px; right: 20px;">
                            <div class="hud-panel text-right">
                                <div class="hud-stat cyan">üéÆ <span id="playerName">Player</span></div>
                                <div class="hud-stat purple">üë• <span id="aliveCount">8</span> alive</div>
                                <div class="hud-stat gold">‚è±Ô∏è <span id="gameTime">0:00</span></div>
                                <div class="hud-stat green">üéüÔ∏è Credits: <span id="inGameCredits">0</span></div>
                            </div>
                        </div>
                        
                        <!-- Sarah Panel -->
                        <div style="position: absolute; bottom: 0; left: 0; right: 0;">
                            <div class="sarah-panel">
                                <div class="sarah-icon">üíÅ‚Äç‚ôÄÔ∏è</div>
                                <div style="flex: 1;">
                                    <div class="sarah-name">SARAH</div>
                                    <div id="sarahText" class="sarah-text">Good luck out there! üíï</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== BUY POND TAB ==================== -->
            <div id="buyTab" class="tab-content">
                <h2 class="section-title gold">üí∞ Bulk POND Packages</h2>
                
                <!-- Wallet Warning -->
                <div id="buyWalletWarning" class="alert warning">
                    <div class="alert-icon">‚ö†Ô∏è</div>
                    <div class="alert-content">
                        <div class="alert-title">Connect Wallet to Purchase</div>
                        <div class="alert-text">You need to connect your wallet first</div>
                    </div>
                    <button class="btn btn-primary" onclick="connectWallet(); switchTab('play');">üîó Connect Wallet</button>
                </div>
                
                <!-- Bulk Purchase Section -->
                <div id="bulkPurchaseSection" style="display: none;">
                    <div class="grid-auto-lg mb-3">
                        <!-- Starter Package -->
                        <div class="cyber-card package-card">
                            <div class="corner tl"></div>
                            <div class="corner tr"></div>
                            <div class="corner bl"></div>
                            <div class="corner br"></div>
                            <div class="package-tier">Starter</div>
                            <div class="package-price">$500</div>
                            <div class="package-discount">2% Discount</div>
                            <div class="package-detail">
                                <div class="package-detail-label">You pay</div>
                                <div class="package-detail-value" id="pkg500Sgb">~250,000 SGB</div>
                            </div>
                            <div class="package-detail">
                                <div class="package-detail-label">You receive (+2%)</div>
                                <div class="package-detail-value gold" id="pkg500Bake">Loading...</div>
                            </div>
                            <button class="btn btn-blue btn-block" onclick="buyPackage(500, 2)">BUY $500 PACKAGE</button>
                        </div>
                        
                        <!-- Builder Package -->
                        <div class="cyber-card package-card featured">
                            <div class="package-badge">Popular</div>
                            <div class="corner tl"></div>
                            <div class="corner tr"></div>
                            <div class="corner bl"></div>
                            <div class="corner br"></div>
                            <div class="package-tier">Builder</div>
                            <div class="package-price">$1,000</div>
                            <div class="package-discount">5% Discount</div>
                            <div class="package-detail">
                                <div class="package-detail-label">You pay</div>
                                <div class="package-detail-value" id="pkg1000Sgb">~500,000 SGB</div>
                            </div>
                            <div class="package-detail">
                                <div class="package-detail-label">You receive (+5%)</div>
                                <div class="package-detail-value gold" id="pkg1000Bake">Loading...</div>
                            </div>
                            <button class="btn btn-gold btn-block" onclick="buyPackage(1000, 5)">BUY $1,000 PACKAGE</button>
                        </div>
                        
                        <!-- Whale Package -->
                        <div class="cyber-card package-card">
                            <div class="package-badge purple">Whale</div>
                            <div class="corner tl"></div>
                            <div class="corner tr"></div>
                            <div class="corner bl"></div>
                            <div class="corner br"></div>
                            <div class="package-tier">Believer</div>
                            <div class="package-price">$5,000</div>
                            <div class="package-discount">10% Discount</div>
                            <div class="package-detail">
                                <div class="package-detail-label">You pay</div>
                                <div class="package-detail-value" id="pkg5000Sgb">~2,500,000 SGB</div>
                            </div>
                            <div class="package-detail">
                                <div class="package-detail-label">You receive (+10%)</div>
                                <div class="package-detail-value gold" id="pkg5000Bake">Loading...</div>
                            </div>
                            <button class="btn btn-purple btn-block" onclick="buyPackage(5000, 10)">BUY $5,000 PACKAGE</button>
                        </div>
                    </div>
                    
                    <!-- Vesting Status -->
                    <div id="vestStatus" class="cyber-card purple" style="display: none;">
                        <div class="corner tl"></div>
                        <div class="corner tr"></div>
                        <div class="corner bl"></div>
                        <div class="corner br"></div>
                        <h3 class="section-title" style="color: var(--accent-purple);">üîí Your Vesting POND</h3>
                        <div class="grid-2 mb-2">
                            <div class="stat-box">
                                <div class="stat-box-label">Total Purchased</div>
                                <div class="stat-box-value gold" id="vestTotal">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-label">Already Claimed</div>
                                <div class="stat-box-value" style="color: var(--text-muted);" id="vestClaimed">0</div>
                            </div>
                        </div>
                        <div class="stat-box mb-2" style="background: rgba(16, 185, 129, 0.15);">
                            <div class="stat-box-label">Claimable Now</div>
                            <div class="stat-box-value green" id="vestClaimable">0 POND</div>
                            <div style="font-size: 11px; color: var(--accent-orange); margin-top: 4px;" id="vestTimeRemaining">60 days remaining</div>
                        </div>
                        <button class="btn btn-purple btn-block" onclick="claimBulkBAKE()">üéÅ CLAIM VESTED POND</button>
                    </div>
                </div>
            </div>

            <!-- ==================== POOL TAB ==================== -->
            <div id="poolTab" class="tab-content">
                <h2 class="section-title">üíß POND/SGB Liquidity Pool</h2>
                
                <!-- Pool Stats -->
                <div class="grid-2 mb-3">
                    <div class="stat-box">
                        <div class="stat-box-label">SGB Reserves</div>
                        <div class="stat-box-value green" id="poolWsgb">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">POND Reserves</div>
                        <div class="stat-box-value gold" id="poolBake">0</div>
                    </div>
                </div>
                
                <!-- Price Display -->
                <div class="cyber-card gold text-center mb-3">
                    <div class="form-label">POND Price</div>
                    <div class="stat-box-value gold mb-1" style="font-size: 28px;"><span id="pondPrice">0.000000</span> SGB</div>
                    <div class="stat-box-value green mb-2" style="font-size: 18px;">Market Cap: $<span id="marketCap">0</span></div>
                    <div style="font-size: 14px; font-weight: bold;" id="allTimeChange">All-Time: +0.00%</div>
                </div>
                
                <!-- LP Dashboard (hidden until connected) -->
                <div id="lpDashboard" class="cyber-card purple mb-3" style="display: none;">
                    <div class="corner tl"></div>
                    <div class="corner tr"></div>
                    <div class="corner bl"></div>
                    <div class="corner br"></div>
                    <h3 class="text-center mb-2" style="color: var(--accent-purple);">üìä Your LP Position</h3>
                    
                    <div class="grid-2 mb-2">
                        <div class="stat-box">
                            <div class="stat-box-label">Your Pool Share</div>
                            <div class="stat-box-value purple" id="lpPoolPercent">0%</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-label">Your Multiplier</div>
                            <div class="stat-box-value gold" id="lpMultiplier">1x</div>
                        </div>
                    </div>
                    
                    <div class="grid-2 mb-2">
                        <div class="stat-box">
                            <div class="stat-box-label">SGB Deposited</div>
                            <div class="stat-box-value green" id="lpSgbDeposited">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-label">POND Deposited</div>
                            <div class="stat-box-value gold" id="lpBakeDeposited">0</div>
                        </div>
                    </div>
                    
                    <div class="stat-box mb-2">
                        <div class="stat-box-label">Lock Status</div>
                        <div style="font-size: 14px; font-weight: bold; color: var(--accent-orange);" id="lpLockStatus">-</div>
                    </div>
                    
                    <!-- Rewards Section -->
                    <div class="lp-rewards-section">
                        <div class="lp-rewards-title">üéÅ Your Rewards</div>
                        <div class="grid-2 mb-2">
                            <div class="text-center">
                                <div class="stat-box-label">POND (Claim Now)</div>
                                <div class="stat-box-value gold" style="font-size: 18px;" id="lpPendingBake">0</div>
                                <button class="btn btn-gold btn-sm mt-1" onclick="claimPondRewards()">Claim POND</button>
                            </div>
                            <div class="text-center">
                                <div class="stat-box-label">SGB (Claimable)</div>
                                <div class="stat-box-value green" style="font-size: 18px;" id="lpClaimableSgb">0</div>
                                <button class="btn btn-green btn-sm mt-1" onclick="claimSgbRewards()">Claim SGB</button>
                            </div>
                        </div>
                        <div class="stat-box text-center">
                            <div class="stat-box-label">SGB Pending (Next Claim)</div>
                            <div style="font-size: 16px; font-weight: bold; color: var(--text-muted);" id="lpPendingSgb">0</div>
                            <div style="font-size: 11px; color: var(--accent-orange);" id="lpSgbCountdown">-</div>
                        </div>
                    </div>
                    
                    <div class="lp-next-tier mb-2">
                        Add <span id="lpSgbNeeded" style="font-weight: bold;">0</span> SGB to reach <span id="lpNextPercent" style="font-weight: bold;">1%</span> pool share
                    </div>
                    
                    <div id="lpUnlockSection" class="text-center" style="display: none;">
                        <div style="font-size: 14px; color: var(--accent-green); margin-bottom: 10px;">üîì Lock expired!</div>
                        <button class="btn btn-secondary btn-sm" onclick="relockPosition(0)">Relock 30d</button>
                        <button class="btn btn-secondary btn-sm" onclick="relockPosition(1)">Relock 90d</button>
                        <button class="btn btn-purple btn-sm" onclick="relockPosition(2)">Relock 180d</button>
                        <button class="btn btn-danger btn-sm" onclick="removeLiquidity()">Withdraw</button>
                    </div>
                </div>
                
                <!-- Add Liquidity -->
                <div id="addLiquiditySection" class="cyber-card green mb-3">
                    <div class="corner tl"></div>
                    <div class="corner tr"></div>
                    <div class="corner bl"></div>
                    <div class="corner br"></div>
                    <h3 class="text-center mb-2" style="color: var(--accent-green);">üíß Add Liquidity</h3>
                    
                    <div class="stat-box text-center mb-2" style="background: rgba(139, 92, 246, 0.15);">
                        <div class="stat-box-label">Your NFT Bonus</div>
                        <div class="stat-box-value purple" id="userNftBonus">+0.000x</div>
                    </div>
                    
                    <div class="form-group">
                        <div class="form-label">Lock Period</div>
                        <select id="lockTierSelect" class="cyber-select">
                            <option value="0">30 Days (1x)</option>
                            <option value="1">90 Days (1.5x)</option>
                            <option value="2" selected>180 Days (2.5x)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <div class="form-label">SGB Amount</div>
                        <input type="number" id="wsgbInput" class="cyber-input centered" placeholder="0.0">
                    </div>
                    
                    <div class="form-group">
                        <div class="form-label">POND Amount (auto-calculated at 0.5x ratio)</div>
                        <input type="number" id="bakeRequired" class="cyber-input centered" placeholder="0.0" readonly>
                    </div>
                    
                    <div id="firstDepositorToggle" class="text-center mb-2" style="display: none;">
                        <label style="color: var(--accent-orange); font-size: 14px; cursor: pointer;">
                            <input type="checkbox" id="isFirstDepositor" onchange="toggleFirstDepositor()" style="margin-right: 8px;">
                            I am first depositor (set custom ratio)
                        </label>
                    </div>
                    
                    <button class="btn btn-green btn-block btn-lg" onclick="addLiquidity()">üíß ADD LIQUIDITY</button>
                </div>
                
                <!-- Swap Section -->
                <div class="cyber-card blue">
                    <div class="corner tl"></div>
                    <div class="corner tr"></div>
                    <div class="corner bl"></div>
                    <div class="corner br"></div>
                    <h3 class="text-center mb-2" style="color: var(--accent-blue);">üîÑ Swap Tokens</h3>
                    
                    <div class="form-group">
                        <div class="form-label">From</div>
                        <input type="number" id="swapFromAmount" class="cyber-input centered" placeholder="0.0">
                        <select id="swapFromToken" class="cyber-select mt-1">
                            <option value="SGB">SGB</option>
                            <option value="POND">POND</option>
                        </select>
                    </div>
                    
                    <div class="text-center mb-2" style="font-size: 24px;">‚¨áÔ∏è</div>
                    
                    <div class="form-group">
                        <div class="form-label">To (estimated)</div>
                        <input type="number" id="swapToAmount" class="cyber-input centered" placeholder="0.0" readonly>
                    </div>
                    
                    <button class="btn btn-blue btn-block btn-lg" onclick="executeSwap()">üîÑ SWAP</button>
                </div>
            </div>

            <!-- ==================== LEADERBOARD TAB ==================== -->
            <div id="leaderboardTab" class="tab-content">
                <h2 class="section-title gold">üèÜ TOP PLAYERS</h2>
                <div class="leaderboard mb-4" id="leaderboardList"></div>
                
                <h2 class="section-title blue">üìä YOUR HISTORY</h2>
                <div class="cyber-card" style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Action</th>
                                <th class="text-right">Amount</th>
                                <th class="text-center">Type</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="4" class="text-center" style="color: var(--text-muted); padding: 24px;">No history yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ==================== MARKETPLACE TAB ==================== -->
            <div id="marketplaceTab" class="tab-content">
                <h2 class="section-title pink">‚ú® POND Marketplace</h2>
                
                <!-- Wallet Warning -->
                <div id="marketplaceWalletWarning" class="alert warning">
                    <div class="alert-icon">‚ö†Ô∏è</div>
                    <div class="alert-content">
                        <div class="alert-title">Connect Wallet to Shop</div>
                        <div class="alert-text">You need to connect your wallet first</div>
                    </div>
                    <button class="btn btn-primary" onclick="connectWallet()">üîó Connect Wallet</button>
                </div>
                
                <!-- Category Tabs -->
                <div class="category-tabs">
                    <div onclick="showCategory('tacticals')" class="category-tab-btn active">‚öîÔ∏è Tacticals</div>
                    <div onclick="showCategory('skins')" class="category-tab-btn">üé® Skins</div>
                    <div onclick="showCategory('trails')" class="category-tab-btn">‚ú® Trails</div>
                    <div onclick="showCategory('effects')" class="category-tab-btn">üí• Death FX</div>
                </div>
                
                <!-- Marketplace Items Grid -->
                <div id="marketplaceItems" class="grid-auto"></div>
            </div>
        </div>
    </div>

    <script>
        // Generate particles
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (10 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }
        createParticles();

        // ==================== CONFIGURATION ====================
        const SONGBIRD_RPC = 'https://songbird-api.flare.network/ext/C/rpc';
        const BACKEND_URL = 'https://just-presence-production-2e9e.up.railway.app';
        const CONTRACTS = {
            POND_TOKEN: '0x39fec3F97668e393862Dbb3C442f3Dd3d5016D69',
            GAME_CONTRACT: '0xaB27737d60ce0FaC521f82e3d2703d0D1c279E49',
            POOL_CONTRACT: '0x4A1975d708F713DBD3fFF3C7B6afB289a23A49Ca',
            WSGB: '0x02f0826ef6aD107Cfc861152B32B52fD11BaB9ED',
            STOADZ_NFT: '0x0F02AD5e75f849DBcdA29A0A14e2a9EC7eF55E8e',
            SONGBIRD_CITY_NFT: '0xe7ddcDf9db2C4e86f9A94c0a38e0dD0f5C7d5F48',
            LUXURY_LOFTS_NFT: '0x3E51C96B6D4D8a8E1F3A8E9a6F5B3D1c2E4A5B6C'
        };
        
        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)"
        ];
        
        const POOL_ABI = [
            "function addLiquidity(uint256 pondAmount, uint256 lockTier) payable returns (uint256)",
            "function removeLiquidity() returns (uint256, uint256)",
            "function claimPondRewards() returns (uint256)",
            "function claimSgbRewards() returns (uint256)",
            "function relockPosition(uint256 newTier)",
            "function swapSgbForPond() payable returns (uint256)",
            "function swapPondForSgb(uint256 pondAmount) returns (uint256)",
            "function reserveSGB() external view returns (uint256)",
            "function reservePOND() external view returns (uint256)",
            "function positions(address) view returns (uint256 sgbDeposited, uint256 pondDeposited, uint256 shares, uint256 lockTier, uint256 lockEnd, uint256 pendingPond, uint256 pendingSgb, uint256 lastSgbClaim)",
            "function totalShares() view returns (uint256)"
        ];
        
        const NFT_ABI = ["function balanceOf(address) view returns (uint256)"];

        // ==================== STATE ====================
        let wallet = null, balance = 100000, sgbBalance = 1000;
        let gameCredits = parseInt(localStorage.getItem('gameCredits') || '0');
        let provider, signer, pondContract, poolContract;
        let selectedVehicle = null, currentModal = null;
        let sgbPriceUSD = 0.0027;
        let userHistory = JSON.parse(localStorage.getItem('bakeHistory') || '[]');
        let leaderboard = JSON.parse(localStorage.getItem('bakeLeaderboard') || '[]');
        
        const MARKETPLACE = {
            skins: [{id:'gold',name:'Golden Warrior',rarity:'legendary',price:50000,icon:'üèÜ',desc:'Shine like a champion'},{id:'chrome',name:'Chrome Crusader',rarity:'epic',price:35000,icon:'üíé',desc:'Reflective perfection'},{id:'neon',name:'Neon Racer',rarity:'epic',price:40000,icon:'üåü',desc:'Glow in the dark'},{id:'camo',name:'Digital Camo',rarity:'rare',price:25000,icon:'üéØ',desc:'Tactical stealth'}],
            trails: [{id:'rainbow',name:'Rainbow Trail',rarity:'epic',price:40000,icon:'üåà',desc:'Taste the rainbow'},{id:'lightning',name:'Lightning Bolt',rarity:'epic',price:35000,icon:'‚ö°',desc:'Electric shock'},{id:'fire',name:'Flame Trail',rarity:'rare',price:25000,icon:'üî•',desc:'Hot shots'}],
            effects: [{id:'confetti',name:'Confetti Burst',rarity:'rare',price:30000,icon:'üéâ',desc:'Party on death'},{id:'nuclear',name:'Nuclear Meltdown',rarity:'epic',price:50000,icon:'‚ò¢Ô∏è',desc:'Atomic explosion'},{id:'blackhole',name:'Black Hole',rarity:'legendary',price:60000,icon:'üåÄ',desc:'Suck everything in'}],
            tacticals: [{id:'orbital',name:'Orbital Laser',rarity:'legendary',price:150000,icon:'üõ∏',desc:'Space laser (180s cd)'},{id:'turret',name:'Auto Turret',rarity:'legendary',price:80000,icon:'üî´',desc:'Deploy turret (60s cd)'},{id:'shield',name:'Shield Dome',rarity:'epic',price:70000,icon:'üõ°Ô∏è',desc:'Block bullets 10s (90s cd)'},{id:'heal',name:'Heal Station',rarity:'rare',price:50000,icon:'‚ù§Ô∏è',desc:'Restore HP (60s cd)'}]
        };
        let inventory = JSON.parse(localStorage.getItem('bakeInventory') || '{"skins":[],"trails":[],"effects":[],"tacticals":[]}');

        // ==================== MODAL SYSTEM ====================
        function closeCurrentModal() { 
            if (currentModal && currentModal.parentNode) { 
                document.body.removeChild(currentModal); 
                currentModal = null; 
            } 
        }
        
        function showCustomModal(title, message, buttons) { 
            if (!buttons) buttons = [{text: 'OK'}]; 
            return new Promise(function(resolve) { 
                closeCurrentModal(); 
                const modal = document.createElement('div'); 
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:10001;backdrop-filter:blur(8px);'; 
                let btnHtml = buttons.map((b, i) => 
                    `<button id="modalBtn${i}" class="btn ${i === 0 ? 'btn-primary' : 'btn-secondary'}">${b.text}</button>`
                ).join(''); 
                modal.innerHTML = `<div class="cyber-card glow" style="max-width: 480px; text-align: center;">
                    <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
                    <div class="font-display" style="font-size: 22px; margin-bottom: 16px;">${title}</div>
                    <div style="color: var(--text-secondary); font-size: 15px; margin-bottom: 28px; line-height: 1.6; white-space: pre-line;">${message}</div>
                    <div class="flex flex-center gap-2">${btnHtml}</div>
                </div>`; 
                document.body.appendChild(modal); 
                currentModal = modal; 
                buttons.forEach(function(b, i) { 
                    document.getElementById('modalBtn'+i).onclick = function() { 
                        closeCurrentModal(); 
                        if (b.onClick) b.onClick(); 
                        resolve(i === 0); 
                    }; 
                }); 
            }); 
        }

        // ==================== CREDITS ====================
        function updateCreditsDisplay() { 
            ['creditsDisplay', 'gameCredits', 'inGameCredits'].forEach(id => { 
                const el = document.getElementById(id); 
                if (el) el.textContent = gameCredits; 
            }); 
            localStorage.setItem('gameCredits', gameCredits.toString()); 
        }

        async function buyCredits(amount) { 
            if (!wallet) { await showCustomModal('‚ö†Ô∏è Wallet Required', 'Connect wallet first'); return; } 
            if (sgbBalance < amount) { await showCustomModal('‚ö†Ô∏è Insufficient SGB', 'You need '+amount+' SGB'); return; } 
            try { 
                const confirmed = await showCustomModal('üéüÔ∏è Buy '+amount+' Credits', 'Pay '+amount+' SGB?', [{text: 'Buy'}, {text: 'Cancel'}]); 
                if (!confirmed) return; 
                showCustomModal('‚è≥ Processing', 'Check MetaMask...'); 
                const tx = await signer.sendTransaction({ to: CONTRACTS.POOL_CONTRACT, value: ethers.utils.parseEther(amount.toString()) }); 
                await tx.wait(); 
                const newSgbBalance = await provider.getBalance(wallet); 
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance)); 
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2); 
                gameCredits += amount; 
                updateCreditsDisplay(); 
                await showCustomModal('‚úÖ Credits Purchased', 'You have '+gameCredits+' credits'); 
            } catch (error) { 
                await showCustomModal('‚ùå Failed', error.message); 
            } 
        }

        // ==================== WALLET ====================
        async function connectWallet() { 
            const walletBtn = document.getElementById('walletBtn'); 
            try { 
                walletBtn.disabled = true; 
                walletBtn.innerHTML = '‚è≥ Connecting...'; 
                provider = new ethers.providers.Web3Provider(window.ethereum); 
                await provider.send("eth_requestAccounts", []); 
                signer = provider.getSigner(); 
                pondContract = new ethers.Contract(CONTRACTS.POND_TOKEN, ERC20_ABI, signer); 
                poolContract = new ethers.Contract(CONTRACTS.POOL_CONTRACT, POOL_ABI, signer); 
                wallet = await signer.getAddress(); 
                const pondBalance = await pondContract.balanceOf(wallet); 
                const sgbBalanceWei = await provider.getBalance(wallet); 
                balance = parseFloat(ethers.utils.formatEther(pondBalance)); 
                sgbBalance = parseFloat(ethers.utils.formatEther(sgbBalanceWei)); 
                
                walletBtn.textContent = '‚úì ' + wallet.substr(0, 6) + '...' + wallet.substr(-4); 
                walletBtn.classList.add('wallet-connected'); 
                walletBtn.onclick = null; 
                
                document.getElementById('walletBanner').style.display = 'block';
                document.getElementById('walletAddrBanner').textContent = wallet.substr(0, 6) + '...' + wallet.substr(-4);
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString(); 
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2); 
                
                document.getElementById('gameSetup').style.display = 'block'; 
                document.getElementById('buyWalletWarning').style.display = 'none'; 
                document.getElementById('bulkPurchaseSection').style.display = 'block'; 
                document.getElementById('marketplaceWalletWarning').style.display = 'none'; 
                document.getElementById('lpDashboard').style.display = 'block';
                
                updateCreditsDisplay(); 
                await updatePoolData();
                await updateLPDashboard();
                await checkNFTBonus();
            } catch (e) { 
                showCustomModal('‚ùå Connection Failed', e.message); 
                walletBtn.disabled = false; 
                walletBtn.innerHTML = 'üîó Connect Wallet'; 
            } 
        }

        async function addSongbirdNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: '0x13',
                        chainName: 'Songbird',
                        nativeCurrency: { name: 'Songbird', symbol: 'SGB', decimals: 18 },
                        rpcUrls: ['https://songbird-api.flare.network/ext/C/rpc'],
                        blockExplorerUrls: ['https://songbird-explorer.flare.network']
                    }]
                });
            } catch (e) {
                showCustomModal('‚ùå Error', e.message);
            }
        }

        async function importBAKEToken() {
            try {
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: { type: 'ERC20', options: { address: CONTRACTS.POND_TOKEN, symbol: 'POND', decimals: 18 } }
                });
            } catch (e) {
                showCustomModal('‚ùå Error', e.message);
            }
        }

        // ==================== POOL DATA ====================
        async function updatePoolData() {
            try {
                const tempProvider = wallet ? provider : new ethers.providers.JsonRpcProvider(SONGBIRD_RPC);
                const tempPoolContract = new ethers.Contract(CONTRACTS.POOL_CONTRACT, ["function reserveSGB() view returns (uint256)", "function reservePOND() view returns (uint256)"], tempProvider);
                const wsgbReserve = await tempPoolContract.reserveSGB();
                const pondReserve = await tempPoolContract.reservePOND();
                const wsgbAmount = parseFloat(ethers.utils.formatEther(wsgbReserve));
                const pondAmount = parseFloat(ethers.utils.formatEther(pondReserve));
                
                document.getElementById('poolWsgb').textContent = wsgbAmount.toFixed(2);
                document.getElementById('poolBake').textContent = Math.floor(pondAmount).toLocaleString();
                
                if (wsgbAmount > 0 && pondAmount > 0) {
                    const price = wsgbAmount / pondAmount;
                    document.getElementById('pondPrice').textContent = price.toFixed(6);
                    const priceUSD = price * sgbPriceUSD;
                    document.getElementById('pondPriceUSD').textContent = priceUSD.toFixed(6);
                    const marketCap = priceUSD * 11900000000;
                    document.getElementById('marketCap').textContent = marketCap.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    document.getElementById('marketcapLP').textContent = marketCap.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    
                    const priceChange = ((price - 0.000003112356) / 0.000003112356) * 100;
                    const changeEl = document.getElementById('allTimeChange');
                    const changePercentEl = document.getElementById('priceChangePercent');
                    changeEl.textContent = 'All-Time: ' + (priceChange >= 0 ? '+' : '') + priceChange.toFixed(2) + '%';
                    changeEl.style.color = priceChange >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    changePercentEl.textContent = (priceChange >= 0 ? '+' : '') + priceChange.toFixed(2);
                }
            } catch (e) {
                console.log('Pool data error:', e);
            }
        }

        async function loadPoolDataWithoutWallet() {
            await updatePoolData();
        }

        async function updateLPDashboard() {
            if (!wallet || !poolContract) return;
            try {
                const position = await poolContract.positions(wallet);
                const totalShares = await poolContract.totalShares();
                
                const sgbDeposited = parseFloat(ethers.utils.formatEther(position.sgbDeposited));
                const pondDeposited = parseFloat(ethers.utils.formatEther(position.pondDeposited));
                const shares = parseFloat(ethers.utils.formatEther(position.shares));
                const total = parseFloat(ethers.utils.formatEther(totalShares));
                const poolPercent = total > 0 ? (shares / total * 100) : 0;
                
                document.getElementById('lpSgbDeposited').textContent = sgbDeposited.toFixed(2);
                document.getElementById('lpBakeDeposited').textContent = Math.floor(pondDeposited).toLocaleString();
                document.getElementById('lpPoolPercent').textContent = poolPercent.toFixed(4) + '%';
                
                const lockTier = position.lockTier.toNumber();
                const multipliers = ['1x', '1.5x', '2.5x'];
                document.getElementById('lpMultiplier').textContent = multipliers[lockTier] || '1x';
                
                const lockEnd = position.lockEnd.toNumber() * 1000;
                const now = Date.now();
                if (lockEnd > now) {
                    const daysLeft = Math.ceil((lockEnd - now) / (1000 * 60 * 60 * 24));
                    document.getElementById('lpLockStatus').textContent = daysLeft + ' days locked';
                    document.getElementById('lpUnlockSection').style.display = 'none';
                } else if (shares > 0) {
                    document.getElementById('lpLockStatus').textContent = 'Unlocked';
                    document.getElementById('lpUnlockSection').style.display = 'block';
                }
                
                const pendingPond = parseFloat(ethers.utils.formatEther(position.pendingPond));
                const pendingSgb = parseFloat(ethers.utils.formatEther(position.pendingSgb));
                document.getElementById('lpPendingBake').textContent = Math.floor(pendingPond).toLocaleString();
                document.getElementById('lpPendingSgb').textContent = pendingSgb.toFixed(4);
                
            } catch (e) {
                console.log('LP dashboard error:', e);
            }
        }

        async function checkNFTBonus() {
            if (!wallet) return;
            try {
                const tempProvider = new ethers.providers.JsonRpcProvider(SONGBIRD_RPC);
                let bonus = 0;
                
                const stoadz = new ethers.Contract(CONTRACTS.STOADZ_NFT, NFT_ABI, tempProvider);
                const stoadzBal = await stoadz.balanceOf(wallet);
                if (stoadzBal.gt(0)) bonus += 0.1;
                
                document.getElementById('userNftBonus').textContent = '+' + bonus.toFixed(3) + 'x';
            } catch (e) {
                console.log('NFT check error:', e);
            }
        }

        // ==================== LP ACTIONS ====================
        async function addLiquidity() {
            if (!wallet) { showCustomModal('‚ö†Ô∏è', 'Connect wallet first'); return; }
            const sgbAmount = parseFloat(document.getElementById('wsgbInput').value);
            const pondAmount = parseFloat(document.getElementById('bakeRequired').value);
            if (!sgbAmount || sgbAmount <= 0) { showCustomModal('‚ö†Ô∏è', 'Enter SGB amount'); return; }
            if (!pondAmount || pondAmount <= 0) { showCustomModal('‚ö†Ô∏è', 'POND amount required'); return; }
            
            try {
                const lockTier = parseInt(document.getElementById('lockTierSelect').value);
                const confirmed = await showCustomModal('üíß Add Liquidity', `Add ${sgbAmount} SGB + ${Math.floor(pondAmount).toLocaleString()} POND?`, [{text: 'Confirm'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                
                showCustomModal('‚è≥ Approving POND...', 'Check MetaMask');
                const pondWei = ethers.utils.parseEther(pondAmount.toString());
                const approveTx = await pondContract.approve(CONTRACTS.POOL_CONTRACT, pondWei);
                await approveTx.wait();
                
                showCustomModal('‚è≥ Adding Liquidity...', 'Check MetaMask');
                const sgbWei = ethers.utils.parseEther(sgbAmount.toString());
                const tx = await poolContract.addLiquidity(pondWei, lockTier, { value: sgbWei });
                await tx.wait();
                
                await showCustomModal('‚úÖ Liquidity Added', 'Your position is now active');
                await updatePoolData();
                await updateLPDashboard();
                
                const newSgbBalance = await provider.getBalance(wallet);
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance));
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                
                const newPondBalance = await pondContract.balanceOf(wallet);
                balance = parseFloat(ethers.utils.formatEther(newPondBalance));
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                
            } catch (e) {
                showCustomModal('‚ùå Failed', e.message);
            }
        }

        async function claimPondRewards() {
            if (!wallet) return;
            try {
                showCustomModal('‚è≥ Claiming POND...', 'Check MetaMask');
                const tx = await poolContract.claimPondRewards();
                await tx.wait();
                await showCustomModal('‚úÖ POND Claimed', 'Rewards added to your wallet');
                await updateLPDashboard();
            } catch (e) {
                showCustomModal('‚ùå Failed', e.message);
            }
        }

        async function claimSgbRewards() {
            if (!wallet) return;
            try {
                showCustomModal('‚è≥ Claiming SGB...', 'Check MetaMask');
                const tx = await poolContract.claimSgbRewards();
                await tx.wait();
                await showCustomModal('‚úÖ SGB Claimed', 'Rewards added to your wallet');
                await updateLPDashboard();
            } catch (e) {
                showCustomModal('‚ùå Failed', e.message);
            }
        }

        async function relockPosition(tier) {
            if (!wallet) return;
            try {
                const tiers = ['30 days', '90 days', '180 days'];
                const confirmed = await showCustomModal('üîí Relock Position', `Lock for ${tiers[tier]}?`, [{text: 'Confirm'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                showCustomModal('‚è≥ Relocking...', 'Check MetaMask');
                const tx = await poolContract.relockPosition(tier);
                await tx.wait();
                await showCustomModal('‚úÖ Position Relocked', `Locked for ${tiers[tier]}`);
                await updateLPDashboard();
            } catch (e) {
                showCustomModal('‚ùå Failed', e.message);
            }
        }

        async function removeLiquidity() {
            if (!wallet) return;
            try {
                const confirmed = await showCustomModal('‚ö†Ô∏è Withdraw Liquidity', 'Remove all your liquidity?', [{text: 'Withdraw'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                showCustomModal('‚è≥ Withdrawing...', 'Check MetaMask');
                const tx = await poolContract.removeLiquidity();
                await tx.wait();
                await showCustomModal('‚úÖ Liquidity Removed', 'Funds returned to your wallet');
                await updatePoolData();
                await updateLPDashboard();
            } catch (e) {
                showCustomModal('‚ùå Failed', e.message);
            }
        }

        async function executeSwap() {
            if (!wallet) { showCustomModal('‚ö†Ô∏è', 'Connect wallet first'); return; }
            const fromAmount = parseFloat(document.getElementById('swapFromAmount').value);
            const fromToken = document.getElementById('swapFromToken').value;
            if (!fromAmount || fromAmount <= 0) { showCustomModal('‚ö†Ô∏è', 'Enter amount'); return; }
            
            try {
                const confirmed = await showCustomModal('üîÑ Confirm Swap', `Swap ${fromAmount} ${fromToken}?`, [{text: 'Swap'}, {text: 'Cancel'}]);
                if (!confirmed) return;
                
                if (fromToken === 'SGB') {
                    showCustomModal('‚è≥ Swapping...', 'Check MetaMask');
                    const tx = await poolContract.swapSgbForPond({ value: ethers.utils.parseEther(fromAmount.toString()) });
                    await tx.wait();
                } else {
                    showCustomModal('‚è≥ Approving...', 'Check MetaMask');
                    const pondWei = ethers.utils.parseEther(fromAmount.toString());
                    const approveTx = await pondContract.approve(CONTRACTS.POOL_CONTRACT, pondWei);
                    await approveTx.wait();
                    showCustomModal('‚è≥ Swapping...', 'Check MetaMask');
                    const tx = await poolContract.swapPondForSgb(pondWei);
                    await tx.wait();
                }
                
                await showCustomModal('‚úÖ Swap Complete', 'Check your wallet');
                await updatePoolData();
                
                const newSgbBalance = await provider.getBalance(wallet);
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance));
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                
                const newPondBalance = await pondContract.balanceOf(wallet);
                balance = parseFloat(ethers.utils.formatEther(newPondBalance));
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                
            } catch (e) {
                showCustomModal('‚ùå Failed', e.message);
            }
        }

        function toggleFirstDepositor() {
            const isFirst = document.getElementById('isFirstDepositor').checked;
            const bakeInput = document.getElementById('bakeRequired');
            if (isFirst) {
                bakeInput.readOnly = false;
                bakeInput.style.color = 'var(--text-primary)';
                bakeInput.value = '';
            } else {
                bakeInput.readOnly = true;
                bakeInput.style.color = 'var(--accent-gold)';
                document.getElementById('wsgbInput').dispatchEvent(new Event('input'));
            }
        }

        // ==================== GAME FLOW ====================
        function selectVehicle() {
            if (gameCredits < 1) {
                showCustomModal('‚ö†Ô∏è No Credits', 'Buy credits to play');
                return;
            }
            document.getElementById('gameSetup').style.display = 'none';
            document.getElementById('vehicleSelect').style.display = 'block';
        }

        function selectVehicleType(icon, hp, dmg) {
            selectedVehicle = { icon, hp, dmg };
            document.getElementById('vehicleSelect').style.display = 'none';
            showMarketplaceUpsell();
        }

        function showMarketplaceUpsell() {
            const unownedTacticals = MARKETPLACE.tacticals.filter(t => !inventory.tacticals.includes(t.id)).slice(0, 3);
            const container = document.getElementById('upsellItems');
            
            if (unownedTacticals.length === 0) {
                proceedToGame();
                return;
            }
            
            container.innerHTML = unownedTacticals.map(item => `
                <div class="marketplace-item" onclick="buyItem('tacticals', '${item.id}', ${item.price}, '${item.name}')">
                    <div class="item-icon-wrap">${item.icon}</div>
                    <div class="item-rarity ${item.rarity}">${item.rarity.toUpperCase()}</div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-desc">${item.desc}</div>
                    <div class="item-price">${item.price.toLocaleString()} POND</div>
                    <button class="item-buy-btn">BUY NOW</button>
                </div>
            `).join('');
            
            document.getElementById('marketplaceUpsell').style.display = 'block';
        }

        function proceedToGame() {
            document.getElementById('marketplaceUpsell').style.display = 'none';
            gameCredits--;
            updateCreditsDisplay();
            startGame();
        }

        function startGame() {
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('playerName').textContent = document.getElementById('username').value || 'Player';
            document.getElementById('playerMaxHP').textContent = selectedVehicle.hp;
            document.getElementById('playerHP').textContent = selectedVehicle.hp;
            // Game initialization would go here
            showSarahMessage('start');
        }

        function showSarahMessage(type) {
            const messages = {
                start: ['Good luck out there! üíï', 'Show them what you got! üî•', 'Time to dominate! üëë'],
                kill: ['Nice one! üéØ', 'Boom! üí•', 'Get rekt! üòà'],
                death: ['Ouch... üò¢', 'You got this! üí™', 'Shake it off! üåü']
            };
            const arr = messages[type] || messages.start;
            document.getElementById('sarahText').textContent = arr[Math.floor(Math.random() * arr.length)];
        }

        // ==================== TABS ====================
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            if (tab === 'leaderboard') updateLeaderboardDisplay();
            if (tab === 'marketplace') showCategory('tacticals');
            if (tab === 'pool' && !wallet) loadPoolDataWithoutWallet();
        }

        // ==================== MARKETPLACE ====================
        function showCategory(category) {
            document.querySelectorAll('.category-tab-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            
            const items = MARKETPLACE[category];
            const container = document.getElementById('marketplaceItems');
            
            container.innerHTML = items.map(item => {
                const owned = inventory[category].includes(item.id);
                return `
                    <div class="marketplace-item ${owned ? 'owned' : ''}" onclick="${owned ? '' : `buyItem('${category}', '${item.id}', ${item.price}, '${item.name}')`}">
                        <div class="item-icon-wrap">${item.icon}</div>
                        <div class="item-rarity ${item.rarity}">${item.rarity.toUpperCase()}</div>
                        <div class="item-name">${item.name}</div>
                        <div class="item-desc">${item.desc}</div>
                        <div class="item-price">${item.price.toLocaleString()} POND</div>
                        <button class="item-buy-btn ${owned ? 'owned' : ''}">${owned ? '‚úì OWNED' : 'BUY NOW'}</button>
                    </div>
                `;
            }).join('');
        }

        async function buyItem(category, itemId, price, name) {
            if (!wallet) { showCustomModal('‚ö†Ô∏è', 'Connect wallet first'); return; }
            if (inventory[category].includes(itemId)) return;
            if (balance < price) {
                showCustomModal('‚ö†Ô∏è Insufficient POND', 'Need ' + price.toLocaleString() + ' POND', [{text: 'Buy POND', onClick: () => switchTab('buy')}, {text: 'Cancel'}]);
                return;
            }
            
            const confirmed = await showCustomModal('üí∞ Confirm Purchase', 'Buy ' + name + ' for ' + price.toLocaleString() + ' POND?', [{text: 'Purchase'}, {text: 'Cancel'}]);
            if (confirmed) {
                balance -= price;
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                inventory[category].push(itemId);
                localStorage.setItem('bakeInventory', JSON.stringify(inventory));
                addHistoryEntry('Bought ' + name, price, 'burn');
                showCustomModal('‚úÖ Purchase Successful', name + ' is now yours!');
                showCategory(category);
            }
        }

        // ==================== PACKAGES ====================
        async function buyPackage(usdAmount, discountPercent) {
            if (!wallet) { showCustomModal('‚ö†Ô∏è', 'Connect wallet first'); return; }
            
            const sgbNeeded = usdAmount / sgbPriceUSD;
            if (sgbBalance < sgbNeeded) {
                showCustomModal('‚ö†Ô∏è Insufficient SGB', `Need ~${Math.ceil(sgbNeeded).toLocaleString()} SGB`);
                return;
            }
            
            const poolWsgb = parseFloat(document.getElementById('poolWsgb').textContent.replace(/,/g, '')) || 1;
            const poolBake = parseFloat(document.getElementById('poolBake').textContent.replace(/,/g, '')) || 1;
            const rate = poolBake / poolWsgb;
            const basePond = sgbNeeded * rate;
            const bonusPond = basePond * (discountPercent / 100);
            const totalPond = basePond + bonusPond;
            
            const confirmed = await showCustomModal('üí∞ Buy Package', `Pay ~${Math.ceil(sgbNeeded).toLocaleString()} SGB\nReceive ~${Math.floor(totalPond).toLocaleString()} POND (+${discountPercent}%)`, [{text: 'Buy Package'}, {text: 'Cancel'}]);
            if (!confirmed) return;
            
            try {
                showCustomModal('‚è≥ Processing...', 'Check MetaMask');
                const tx = await poolContract.swapSgbForPond({ value: ethers.utils.parseEther(sgbNeeded.toFixed(6)) });
                await tx.wait();
                
                await showCustomModal('‚úÖ Package Purchased', `You received ~${Math.floor(totalPond).toLocaleString()} POND!`);
                
                const newSgbBalance = await provider.getBalance(wallet);
                sgbBalance = parseFloat(ethers.utils.formatEther(newSgbBalance));
                document.getElementById('walletSGBBanner').textContent = sgbBalance.toFixed(2);
                
                const newPondBalance = await pondContract.balanceOf(wallet);
                balance = parseFloat(ethers.utils.formatEther(newPondBalance));
                document.getElementById('walletBalBanner').textContent = Math.floor(balance).toLocaleString();
                
                addHistoryEntry(`Bought $${usdAmount} Package`, totalPond, 'buy');
                
            } catch (e) {
                showCustomModal('‚ùå Failed', e.message);
            }
        }

        async function claimBulkBAKE() {
            showCustomModal('‚ö†Ô∏è', 'No vested POND to claim');
        }

        // ==================== HISTORY & LEADERBOARD ====================
        function addHistoryEntry(action, amount, type) {
            userHistory.unshift({
                date: new Date().toLocaleString(),
                action: action,
                amount: amount,
                type: type
            });
            if (userHistory.length > 50) userHistory.pop();
            localStorage.setItem('bakeHistory', JSON.stringify(userHistory));
            updateHistoryTable();
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            if (userHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center" style="color: var(--text-muted); padding: 24px;">No history yet.</td></tr>';
                return;
            }
            
            const typeColors = {
                earn: 'var(--accent-green)',
                burn: 'var(--accent-red)',
                buy: 'var(--accent-gold)',
                sell: 'var(--accent-purple)'
            };
            
            tbody.innerHTML = userHistory.slice(0, 20).map(entry => `
                <tr>
                    <td style="color: var(--text-muted);">${entry.date}</td>
                    <td>${entry.action}</td>
                    <td class="text-right" style="color: ${typeColors[entry.type] || 'var(--text-primary)'}; font-weight: 600;">${typeof entry.amount === 'number' ? entry.amount.toLocaleString() : entry.amount}</td>
                    <td class="text-center"><span style="background: ${typeColors[entry.type]}22; color: ${typeColors[entry.type]}; padding: 4px 10px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${entry.type}</span></td>
                </tr>
            `).join('');
        }

        function updateLeaderboardDisplay() {
            const container = document.getElementById('leaderboardList');
            if (leaderboard.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 40px; color: var(--text-muted);">No games played yet. Be the first!</div>';
                return;
            }
            
            container.innerHTML = leaderboard.slice(0, 10).map((entry, i) => {
                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '#' + (i + 1);
                return `
                    <div class="leaderboard-entry ${i < 3 ? 'top' : ''}">
                        <span class="leaderboard-rank">${medal}</span>
                        <span class="leaderboard-name">${entry.name}</span>
                        <span class="leaderboard-score">${entry.bake.toLocaleString()} POND</span>
                        <span class="leaderboard-kills">${entry.kills} kills</span>
                    </div>
                `;
            }).join('');
        }

        // ==================== SGB PRICE ====================
        async function fetchSGBPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=songbird&vs_currencies=usd');
                const data = await response.json();
                if (data.songbird && data.songbird.usd) {
                    sgbPriceUSD = data.songbird.usd;
                }
            } catch (e) {
                console.log('Price fetch error:', e);
            }
        }

        // ==================== INITIALIZATION ====================
        window.addEventListener('load', async function() {
            await fetchSGBPrice();
            updateHistoryTable();
            updateLeaderboardDisplay();
            updateCreditsDisplay();
            loadPoolDataWithoutWallet();
            
            // Refresh data periodically
            setInterval(async function() {
                if (wallet) {
                    await updatePoolData();
                    await updateLPDashboard();
                } else {
                    await loadPoolDataWithoutWallet();
                }
            }, 10000);
            
            // WSGB input listener for auto-calculating POND
            const wsgbInput = document.getElementById('wsgbInput');
            if (wsgbInput) {
                wsgbInput.addEventListener('input', function() {
                    const wsgbAmount = parseFloat(this.value) || 0;
                    const poolWsgb = parseFloat(document.getElementById('poolWsgb').textContent.replace(/,/g, '')) || 0;
                    const poolBake = parseFloat(document.getElementById('poolBake').textContent.replace(/,/g, '')) || 0;
                    const isFirst = document.getElementById('isFirstDepositor') && document.getElementById('isFirstDepositor').checked;
                    
                    if (wsgbAmount > 0 && poolWsgb > 0 && poolBake > 0 && !isFirst) {
                        const currentRatio = poolBake / poolWsgb;
                        const bakeAt05x = wsgbAmount * currentRatio * 0.5;
                        document.getElementById('bakeRequired').value = bakeAt05x.toFixed(2);
                    } else if (isFirst) {
                        document.getElementById('bakeRequired').value = '';
                    }
                });
            }
            
            // Swap estimate listener
            const swapFromAmount = document.getElementById('swapFromAmount');
            const swapFromToken = document.getElementById('swapFromToken');
            
            function updateSwapEstimate() {
                const fromAmount = parseFloat(swapFromAmount.value) || 0;
                const fromToken = swapFromToken.value;
                
                if (fromAmount > 0) {
                    const poolWsgb = parseFloat(document.getElementById('poolWsgb').textContent.replace(/,/g, '')) || 100000;
                    const poolBake = parseFloat(document.getElementById('poolBake').textContent.replace(/,/g, '')) || 3846154;
                    let toAmount = 0;
                    
                    if (fromToken === 'SGB') {
                        toAmount = poolBake - (poolWsgb * poolBake) / (poolWsgb + fromAmount);
                    } else {
                        toAmount = poolWsgb - (poolWsgb * poolBake) / (poolBake + fromAmount);
                    }
                    
                    document.getElementById('swapToAmount').value = toAmount.toFixed(6);
                } else {
                    document.getElementById('swapToAmount').value = '';
                }
            }
            
            if (swapFromAmount) {
                swapFromAmount.addEventListener('input', updateSwapEstimate);
                swapFromToken.addEventListener('change', updateSwapEstimate);
            }
        });
    </script>
</body>
</html>
